<script>
/* === CONFIG === */
const SUPABASE_URL = 'https://uqtnllwlyxzfvxukvxrb.supabase.co';          // <— pon aquí tu URL real
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxdG5sbHdseXh6ZnZ4dWt2eHJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTc3MjUsImV4cCI6MjA3NDQzMzcyNX0.nHfPuc-LCwGymKqhSRSIp9lmpQLKK53M6eqUP7QepUU';// <— y tu anon key real
const STORAGE_BUCKET = 'fotos';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* === ROUTER BÁSICO === */
window.addEventListener('hashchange', render);
document.addEventListener('DOMContentLoaded', render);

function render(){
  const v = document.getElementById('view');
  const route = (location.hash || '#/cliente').toLowerCase();
  v.innerHTML = route.startsWith('#/doctor') ? doctorTpl() : clienteTpl();
}

/* === VISTAS === */
function clienteTpl(){
  return `
    <div class="card">
      <h2>Consulta de Mascota</h2>
      <input id="q" placeholder="Nombre de la mascota" onkeydown="if(event.key==='Enter') buscarCliente()">
      <button class="btn" onclick="buscarCliente()">Buscar</button>
      <div id="out"></div>
    </div>
  `;
}

function doctorTpl(){
  return `
    <div class="card">
      <h2>Acceso Doctor</h2>
      <input id="email" placeholder="Email">
      <input id="pass" placeholder="Contraseña" type="password">
      <button class="btn" onclick="loginDoctor()">Entrar</button>
      <div id="loginMsg" class="empty"></div>
    </div>

    <div id="panel" style="display:none">
      <div class="card">
        <h2>Buscar Mascota</h2>
        <input id="qd" placeholder="Nombre" onkeydown="if(event.key==='Enter') buscarDoctor()">
        <button class="btn" onclick="buscarDoctor()">Buscar</button>
        <div id="res"></div>
      </div>

      <div class="card">
        <h2>Nuevo Paciente</h2>
        <div class="grid-3">
          <input id="nombre" placeholder="Nombre mascota">
          <input id="raza" placeholder="Raza">
          <input id="edad" placeholder="Edad">
          <select id="sexo"><option value="">Sexo</option><option>Macho</option><option>Hembra</option></select>
          <input id="duenio" placeholder="Dueño">
          <input id="tel" placeholder="Teléfono">
          <input id="mail" placeholder="Email">
        </div>
        <textarea id="hist" placeholder="Historial médico"></textarea>
        <input id="foto" type="file" accept="image/*">
        <button class="btn primary" onclick="guardarDoctor()">Guardar información</button>
        <div id="saveMsg" class="empty"></div>
      </div>
    </div>
  `;
}

/* === RENDER DE TARJETA === */
function renderCard(r){
  return `
    <div class="card">
      <div class="row">
        <div>
          <h3>${esc(r.nombre || '')}</h3>
          <p><b>Raza:</b> ${esc(r.raza || '')} · <b>Edad:</b> ${esc(r.edad ?? '')} · <b>Sexo:</b> ${esc(r.sexo || '')}</p>
          <p><b>Dueño:</b> ${esc(r.duenio || '')} · <b>Tel:</b> ${esc(r.telefono || '')} · <b>Email:</b> ${esc(r.email || '')}</p>
          <p><b>Historial:</b> ${esc(r.historial || '')}</p>
        </div>
        <div class="thumb">${r.foto_url ? `<img src="${r.foto_url}" alt="foto">` : `<div class="empty">Sin foto</div>`}</div>
      </div>
    </div>
  `;
}

/* === LÓGICA CLIENTE === */
async function buscarCliente(){
  const q = document.getElementById('q').value.trim();
  const out = document.getElementById('out');
  out.textContent = 'Buscando...';
  try{
    const { data, error } = await supabase
      .from('mascotas')
      .select('*')
      .ilike('nombre', `%${q}%`)
      .order('created_at', { ascending:false })
      .limit(5);
    if (error) throw error;
    if (!data || !data.length){ out.innerHTML = '<div class="empty">No se encontró registro.</div>'; return; }
    out.innerHTML = data.map(renderCard).join('');
  }catch(err){
    console.error(err);
    out.innerHTML = `<div class="empty">Error: ${esc(err.message || String(err))}</div>`;
  }
}

/* === LÓGICA DOCTOR === */
async function loginDoctor(){
  const email = document.getElementById('email').value.trim();
  const pass  = document.getElementById('pass').value;
  const msg = document.getElementById('loginMsg');
  try{
    const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if (error) throw error;
    msg.textContent = 'OK';
    document.getElementById('panel').style.display = '';
  }catch(err){
    msg.textContent = 'Error: ' + (err.message || String(err));
  }
}

async function buscarDoctor(){
  const q = document.getElementById('qd').value.trim();
  const res = document.getElementById('res');
  res.textContent = 'Buscando...';
  try{
    const { data, error } = await supabase
      .from('mascotas').select('*')
      .ilike('nombre', `%${q}%`)
      .order('created_at', { ascending:false })
      .limit(10);
    if (error) throw error;
    if (!data.length){ res.innerHTML = '<div class="empty">Sin resultados</div>'; return; }
    res.innerHTML = data.map(renderCard).join('');
  }catch(err){
    res.innerHTML = `<div class="empty">Error: ${esc(err.message || String(err))}</div>`;
  }
}

async function guardarDoctor(){
  const saveMsg = document.getElementById('saveMsg');
  saveMsg.textContent = 'Guardando...';
  try{
    // Subir foto (opcional)
    let foto_url = '';
    const file = document.getElementById('foto').files[0];
    if (file){
      const path = `fotos/${Date.now()}_${file.name}`;
      const up = await supabase.storage.from(STORAGE_BUCKET).upload(path, file);
      if (up.error) throw up.error;
      const pub = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
      foto_url = pub.data.publicUrl;
    }
    // Insertar registro
    const rec = {
      nombre:  val('nombre'),
      raza:    val('raza'),
      edad:    parseInt(val('edad')||'0',10),
      sexo:    val('sexo'),
      duenio:  val('duenio'),
      telefono:val('tel'),
      email:   val('mail'),
      historial: val('hist'),
      foto_url
    };
    const { error } = await supabase.from('mascotas').insert(rec);
    if (error) throw error;
    saveMsg.textContent = 'Guardado correctamente';
  }catch(err){
    saveMsg.textContent = 'Error: ' + (err.message || String(err));
  }
}

/* === UTILS === */
function val(id){ return document.getElementById(id).value.trim(); }
function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
</script>

