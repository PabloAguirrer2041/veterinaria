<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veterinaria - Demo Directo</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{ --pri:#2c7a7b; --bg:#f7fafc; --card:#fff; --txt:#1a202c; }
    body{ margin:0; background:var(--bg); color:var(--txt); font-family:Inter,system-ui,Arial; }
    .wrap{ max-width:1000px; margin:0 auto; padding:24px; }
    .top{ display:flex; justify-content:space-between; align-items:center; }
    .tab a{ margin-left:10px; text-decoration:none; background:#222; color:#fff; padding:8px 12px; border-radius:10px; }
    .card{ background:var(--card); border-radius:14px; padding:20px; box-shadow:0 6px 20px rgba(0,0,0,.06); margin-top:18px; }
    input,select,textarea{ width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:10px; }
    textarea{ min-height:110px; }
    .btn{ background:#222; color:#fff; border:none; border-radius:10px; padding:10px 16px; cursor:pointer; }
    .btn.primary{ background:var(--pri); }
    .grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .row{ display:flex; gap:16px; align-items:flex-start; }
    .thumb{ width:140px; min-width:140px; height:140px; display:flex; align-items:center; justify-content:center; background:#f1f5f9; border-radius:10px; overflow:hidden; }
    .thumb img{ width:100%; height:100%; object-fit:cover; }
    .empty{ color:#64748b; }
    @media (max-width:800px){ .grid-3{ grid-template-columns:1fr; } .row{ flex-direction:column; } .thumb{ width:100%; height:180px; } }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>Veterinaria - Demo Directo</h1>
    <div class="tab">
      <a href="#/cliente">Cliente</a>
      <a href="#/doctor">Doctor</a>
    </div>
  </div>

  <div id="view"></div>
</div>

<script>
const SUPABASE_URL = 'https://uqtnllwlyxzfvxukvxrb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxdG5sbHdseXh6ZnZ4dWt2eHJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTc3MjUsImV4cCI6MjA3NDQzMzcyNX0.nHfPuc-LCwGymKqhSRSIp9lmpQLKK53M6eqUP7QepUU';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const STORAGE_BUCKET = 'fotos';

// Ruteo mínimo con hash
window.addEventListener('hashchange', render);
render();

function render(){
  const v = document.getElementById('view');
  const route = (location.hash || '#/cliente').toLowerCase();
  if (route.startsWith('#/doctor')) {
    v.innerHTML = doctorTpl();
  } else {
    v.innerHTML = clienteTpl();
  }
}

function clienteTpl(){
  return `
  <div class="card">
    <h2>Consulta de Mascota</h2>
    <input id="q" placeholder="Nombre de la mascota" onkeydown="if(event.key==='Enter') buscarCliente()">
    <button class="btn" onclick="buscarCliente()">Buscar</button>
    <div id="out"></div>
  </div>`;
}

<script>
async function buscarCliente(){
  const q = document.getElementById('q').value.trim();
  const out = document.getElementById('out');
  out.textContent = 'Buscando...';

  try {
    const { data, error } = await supabase
      .from('mascotas')
      .select('*')
      .ilike('nombre', `%${q}%`)
      .order('created_at', { ascending:false })
      .limit(5);

    if (error) throw error;
    if (!data || !data.length){
      out.innerHTML = '<div class="empty">No se encontró registro.</div>';
      return;
    }
    out.innerHTML = data.map(r => renderCard(r)).join('');
  } catch (err){
    console.error('buscarCliente:', err);
    out.innerHTML = `<div class="empty">Error: ${(err && err.message) ? err.message : String(err)}</div>`;
  }
}
</script>


function renderCard(r){
  return `
  <div class="card">
    <div class="row">
      <div>
        <h3>${esc(r.nombre||'')}</h3>
        <p><b>Raza:</b> ${esc(r.raza||'')} · <b>Edad:</b> ${esc(r.edad||'')} · <b>Sexo:</b> ${esc(r.sexo||'')}</p>
        <p><b>Dueño:</b> ${esc(r.duenio||'')} · <b>Tel:</b> ${esc(r.telefono||'')} · <b>Email:</b> ${esc(r.email||'')}</p>
        <p><b>Historial:</b> ${esc(r.historial||'')}</p>
      </div>
      <div class="thumb">${r.foto_url ? `<img src="${r.foto_url}">` : `<div class="empty">Sin foto</div>`}</div>
    </div>
  </div>`;
}

function doctorTpl(){
  return `
  <div class="card">
    <h2>Acceso Doctor</h2>
    <input id="email" placeholder="Email">
    <input id="pass" placeholder="Contraseña" type="password">
    <button class="btn" onclick="loginDoctor()">Entrar</button>
    <div id="loginMsg" class="empty"></div>
  </div>
  <div id="panel" style="display:none">
    <div class="card">
      <h2>Buscar Mascota</h2>
      <input id="qd" placeholder="Nombre" onkeydown="if(event.key==='Enter') buscarDoctor()">
      <button class="btn" onclick="buscarDoctor()">Buscar</button>
      <div id="res"></div>
    </div>
    <div class="card">
      <h2>Nuevo Paciente</h2>
      <div class="grid-3">
        <input id="nombre" placeholder="Nombre mascota">
        <input id="raza" placeholder="Raza">
        <input id="edad" placeholder="Edad">
        <select id="sexo"><option value="">Sexo</option><option>Macho</option><option>Hembra</option></select>
        <input id="duenio" placeholder="Dueño">
        <input id="tel" placeholder="Teléfono">
        <input id="mail" placeholder="Email">
      </div>
      <textarea id="hist" placeholder="Historial médico"></textarea>
      <input id="foto" type="file" accept="image/*">
      <button class="btn primary" onclick="guardarDoctor()">Guardar información</button>
      <div id="saveMsg" class="empty"></div>
    </div>
  </div>`;
}

async function loginDoctor(){
  const email = document.getElementById('email').value.trim();
  const pass  = document.getElementById('pass').value;
  const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
  const msg = document.getElementById('loginMsg');
  if (error){ msg.textContent = 'Error: ' + error.message; return; }
  msg.textContent = 'OK';
  document.getElementById('panel').style.display = '';
}

<script>
async function buscarCliente(){
  const q = document.getElementById('q').value.trim();
  const out = document.getElementById('out');
  out.textContent = 'Buscando...';

  try {
    const { data, error } = await supabase
      .from('mascotas')
      .select('*')
      .ilike('nombre', `%${q}%`)
      .order('created_at', { ascending:false })
      .limit(5);

    if (error) throw error;
    if (!data || !data.length){
      out.innerHTML = '<div class="empty">No se encontró registro.</div>';
      return;
    }
    out.innerHTML = data.map(r => renderCard(r)).join('');
  } catch (err){
    console.error('buscarCliente:', err);
    out.innerHTML = `<div class="empty">Error: ${(err && err.message) ? err.message : String(err)}</div>`;
  }
}
</script>


async function guardarDoctor(){
  const saveMsg = document.getElementById('saveMsg');
  saveMsg.textContent = 'Guardando...';

  // Subir foto (opcional) a Supabase Storage
  let foto_url = '';
  const file = document.getElementById('foto').files[0];
  if (file){
    const path = `fotos/${Date.now()}_${file.name}`;
   const { data:up, error:errUp } = await supabase.storage.from(STORAGE_BUCKET).upload(path, file);
if (errUp){ saveMsg.textContent = 'Error al subir foto: ' + errUp.message; return; }
const { data:pub } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
const foto_url = pub.publicUrl;
  }

  const rec = {
    nombre:  val('nombre'),
    raza:    val('raza'),
    edad:    parseInt(val('edad')||'0',10),
    sexo:    val('sexo'),
    duenio:  val('duenio'),
    telefono:val('tel'),
    email:   val('mail'),
    historial: val('hist'),
    foto_url
  };

  const { error } = await supabase.from('mascotas').insert(rec);
  if (error){ saveMsg.textContent = 'Error: ' + error.message; return; }
  saveMsg.textContent = 'Guardado correctamente';
}

function val(id){ return document.getElementById(id).value.trim(); }
function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }
</script>
</body>
</html>
