<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfil de Mascota</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{ --bg:#f6f9fb; --card:#fff; --ink:#0f172a; --muted:#5b6b83; --brand:#0ea5a0; --line:#e6eef4; }
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,sans-serif;padding:20px;}
    .container{max-width:600px;margin:auto;}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);}
    img.profile{width:100%;height:250px;object-fit:cover;border-radius:12px;margin-bottom:15px;background:#eee;}
    h1{margin:0 0 10px;}
    .row{display:flex;justify-content:space-between;margin-bottom:8px;border-bottom:1px solid #eee;padding-bottom:8px;}
    .label{font-weight:600;color:var(--muted);}
    .btn{background:var(--brand);color:#fff;border:none;padding:10px 15px;border-radius:8px;font-weight:bold;cursor:pointer;width:100%;margin-top:10px;}
    #debugLog{margin-top:20px;padding:10px;background:#000;color:#0f0;font-family:monospace;font-size:12px;border-radius:8px;white-space:pre-wrap;}
  </style>
</head>
<body>

<div class="container">
  <div class="card" id="mainCard">
    <h2 style="text-align:center; color: var(--muted);">Cargando sistema...</h2>
  </div>
  
  <div id="debugLog">Iniciando diagnóstico...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
  // --- CONFIGURACIÓN ---
  const SUPABASE_URL = "https://uqtnllwlyxzfvxukvxrb.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxdG5sbHdseXh6ZnZ4dWt2eHJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTc3MjUsImV4cCI6MjA3NDQzMzcyNX0.nHfPuc-LCwGymKqhSRSIp9lmpQLKK53M6eqUP7QepUU";

  // --- LOGGING EN PANTALLA ---
  const logBox = document.getElementById('debugLog');
  function log(msg) {
    console.log(msg);
    logBox.textContent += "\n> " + msg;
  }

  // --- INICIO ---
  window.onload = async function() {
    log("Ventana cargada.");

    if (!window.supabase) {
      log("ERROR CRÍTICO: La librería de Supabase no cargó desde el CDN.");
      return;
    }
    log("Librería Supabase detectada.");

    try {
      // 1. Iniciar Cliente
      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      log("Cliente Supabase creado.");

      // 2. Obtener ID de la URL
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      log("ID buscado: " + id);

      if (!id) {
        document.getElementById('mainCard').innerHTML = "<h1>⚠️ Falta ID</h1><p>El enlace está incompleto.</p>";
        return;
      }

      // 3. Intentar leer la VISTA PÚBLICA primero (sin auth)
      log("Consultando base de datos (Vista Pública)...");
      
      // NOTA: Usamos 'maybeSingle' para que no lance error si no encuentra nada, solo devuelva null
      const { data, error } = await supa
        .from('mascotas_perfil_publico')
        .select('*')
        .eq('id', id)
        .maybeSingle();

      if (error) {
        log("ERROR SQL: " + error.message);
        throw error;
      }

      if (!data) {
        log("No se encontraron datos. Verificando si eres doctor...");
        // Si no está en la pública, intentamos verificar sesión
        checkDoctorAccess(supa, id);
        return;
      }

      log("¡Datos recibidos! Renderizando...");
      renderProfile(data);

    } catch (e) {
      log("EXCEPCIÓN: " + e.message);
      document.getElementById('mainCard').innerHTML = `<h1>Error</h1><p>${e.message}</p>`;
    }
  };

  async function checkDoctorAccess(supa, id) {
    const { data: { session } } = await supa.auth.getSession();
    if (!session) {
      log("No hay sesión activa y no es público.");
      document.getElementById('mainCard').innerHTML = "<h1>No encontrado</h1><p>Este perfil no es público.</p><button class='btn' onclick='location.href=\"programador.html\"'>Ir al Login de Doctor</button>";
      return;
    }

    log("Sesión detectada: " + session.user.email);
    // Intento leer tabla privada
    const { data, error } = await supa.from('mascotas').select('*').eq('id', id).single();
    
    if (data) {
      renderProfile(data, true);
    } else {
      log("Tampoco se encontró en tabla privada.");
      document.getElementById('mainCard').innerHTML = "<h1>404</h1><p>Mascota no encontrada.</p>";
    }
  }

  function renderProfile(pet, isDoctor = false) {
    const foto = pet.foto_url || "https://via.placeholder.com/300?text=Sin+Foto";
    const title = isDoctor ? `(Vista Doctor) ${pet.nombre}` : pet.nombre;
    
    const html = `
      <h1>${title}</h1>
      <img src="${foto}" class="profile">
      <div class="row"><span class="label">Raza:</span> <span>${pet.raza || '-'}</span></div>
      <div class="row"><span class="label">Sexo:</span> <span>${pet.sexo || '-'}</span></div>
      
      <div style="background:#fff3cd; padding:10px; border-radius:8px; margin-top:15px;">
        <div class="label">⚠️ En caso de extravío:</div>
        <div style="font-size:1.2em; font-weight:bold;">${pet.duenio || 'No registrado'}</div>
        <div style="font-size:1.2em; color:var(--brand);">${pet.telefono || 'Sin teléfono'}</div>
      </div>

      <div style="margin-top:15px;">
        <div class="label">Notas Públicas:</div>
        <p>${pet.notas_publicas || 'Sin notas adicionales.'}</p>
      </div>
      
      ${isDoctor ? `<div style="margin-top:15px; border-top:2px dashed #ccc; padding-top:10px;">
        <div class="label">HISTORIAL PRIVADO:</div>
        <p>${pet.historial || '-'}</p>
      </div>` : ''}
    `;
    document.getElementById('mainCard').innerHTML = html;
  }
</script>
</body>
</html>