<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doctor ¬∑ Registro de mascotas</title>

  <!-- (opcional) ayuda a que el navegador no use copia vieja -->
  <meta http-equiv="Cache-Control" content="no-store, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{ --bg:#f6f9fb; --card:#ffffff; --ink:#0f172a; --muted:#5b6b83; --brand:#0ea5a0; --line:#e6eef4; --shadow:0 10px 30px rgba(16,24,40,.06) }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:980px;margin:auto;padding:20px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .link{color:var(--brand);font-weight:700;text-decoration:none}
    .muted{color:var(--muted)}
    .btn{border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn--brand{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn--danger{background:#ef4444;border-color:#ef4444;color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px}
    h1{margin:0 0 10px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    label{font-size:12px;color:#5b6b83}
    input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#93d9d7;box-shadow:0 0 0 3px rgba(14,165,160,.15)}
    textarea{min-height:110px;resize:vertical}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .results{margin-top:16px;display:grid;gap:10px}
    .item{display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .item img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef4ff;color:#305fbd;font-weight:600;font-size:12px}
    #log{margin-top:12px;white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1220;color:#e6edf3;border-radius:12px;padding:10px;max-height:220px;overflow:auto}
    footer{padding:22px 0;color:#6b7280;text-align:center}
    .hide{display:none}
    .login{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .login input{width:auto}
  </style>

  <!-- 1) Carga local de la librer√≠a -->
  <script src="lib/supabase.min.js" defer></script>

  <!-- 2) Fallback a CDN solo si lo local no puso window.supabase -->
  <script>
    window.addEventListener('load', function(){
      if (window.supabase) return;
      const cdns = [
        "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.6/dist/umd/supabase.min.js",
        "https://unpkg.com/@supabase/supabase-js@2.45.6/dist/umd/supabase.min.js"
      ];
      (function next(i){
        if (window.supabase || i>=cdns.length) return;
        const s = document.createElement('script');
        s.src = cdns[i]; s.defer = true;
        s.onload = ()=>console.log("[supabase] cargado desde CDN");
        s.onerror = ()=>{ console.warn("[supabase] CDN fallback‚Ä¶"); next(i+1); };
        document.head.appendChild(s);
      })(0);
    });
  </script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="link" href="index.html">‚Üê Volver al men√∫</a>
      <div class="login" id="loginBox">
        <span id="sessionState" class="muted">Sesi√≥n: desconectado</span>
        <input id="docId"  name="username" type="text" placeholder="ID (p.ej. DRPERRON1)"
               autocomplete="username" autocapitalize="off" autocorrect="off" spellcheck="false">
        <input id="docPwd" name="password" type="password" placeholder="Contrase√±a"
               autocomplete="current-password">
        <button id="btnLogin"  type="button" class="btn">Iniciar sesi√≥n</button>
        <button id="btnLogout" type="button" class="btn hide">Cerrar sesi√≥n</button>
      </div>
    </div>

    <div class="card">
      <h1>Doctor ¬∑ Registro de mascotas <span class="pill" id="state">offline</span></h1>
      <p class="muted" style="margin-top:-4px">Solo doctores autorizados pueden crear o editar registros.</p>

      <div class="row" style="margin:8px 0 14px">
        <input id="q" type="search" placeholder="Buscar por nombre o ID (ej. 'Luna' o '102')">
        <button id="btnSearch" class="btn btn--brand" type="button">Buscar</button>
      </div>

      <div class="grid">
        <div><label>Nombre</label><input id="f_nombre" type="text" placeholder="Nombre de la mascota"></div>
        <div><label>Raza</label><input id="f_raza" type="text" placeholder="Beagle / Criollo‚Ä¶"></div>
        <div><label>Edad</label><input id="f_edad" type="number" min="0" step="1" placeholder="4"></div>
        <div><label>Sexo</label><select id="f_sexo"><option value="">‚Äî</option><option>Hembra</option><option>Macho</option></select></div>
        <div><label>Due√±o (nombre)</label><input id="f_duenio" type="text" placeholder="Nombre del propietario"></div>
        <div><label>Tel√©fono</label><input id="f_tel" type="tel" placeholder="+52 81‚Ä¶"></div>
        <div><label>Email</label><input id="f_email" type="email" placeholder="propietario@correo.com"></div>
        <div><label>Foto (opcional)</label><input id="f_foto" type="file" accept="image/*"></div>
        <div style="grid-column:1/-1"><label>Historial / notas</label><textarea id="f_hist" placeholder="Vacunas, alergias, observaciones‚Ä¶"></textarea></div>
      </div>

      <div class="actions">
        <button id="btnSave"   class="btn btn--brand" type="button" disabled>Guardar (nuevo)</button>
        <button id="btnUpdate" class="btn" type="button" disabled>Actualizar</button>
        <button id="btnDelete" class="btn btn--danger" type="button" disabled>Eliminar</button>
      </div>

      <div id="log" class="hide"></div>
    </div>

    <div id="results" class="results"></div>
    <footer>¬© <span id="y"></span> TuVet</footer>
  </div>

  <!-- App: todo el JS aqu√≠ (igual que tu versi√≥n estable) -->
  <script>
  (function(){
    'use strict';
    const SUPABASE_URL = "https://uqtnllwlyxzfvxukvxrb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxdG5sbHdseXh6ZnZ4dWt2eHJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTc3MjUsImV4cCI6MjA3NDQzMzcyNX0.nHfPuc-LCwGymKqhSRSIp9lmpQLKK53M6eqUP7QepUU";

    const $ = (s)=>document.querySelector(s);
    const uuid = ()=> (crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2)));
    const idToEmail = (id)=> `${String(id||"").trim().toLowerCase()}@doctores.local`;

    let supa=null, user=null, current=null;

    function setOnline(on){
      const pill=$("#state");
      pill.textContent = on ? "online" : "offline";
      pill.style.background = on ? "#e8fbfb" : "#ffeaea";
      pill.style.color = on ? "#075e59" : "#8b1a1a";
      $("#btnSave").disabled   = !on;
      $("#btnUpdate").disabled = !on || !current;
      $("#btnDelete").disabled = !on || !current;
      $("#docId").disabled  = on;
      $("#docPwd").disabled = on;
    }
    function logMsg(m){ const el=$("#log"); el.classList.remove("hide"); el.textContent += m + "\n"; el.scrollTop = el.scrollHeight; }
    function fillForm(p){
      $("#f_nombre").value = p?.nombre || "";
      $("#f_raza").value   = p?.raza   || "";
      $("#f_edad").value   = p?.edad   ?? "";
      $("#f_sexo").value   = p?.sexo   || "";
      $("#f_duenio").value = p?.duenio || "";
      $("#f_tel").value    = p?.telefono || "";
      $("#f_email").value  = p?.email || "";
      $("#f_hist").value   = p?.historial || "";
    }

    async function ensureSupa(){
      if (supa) return supa;
      // espera a que la librer√≠a UMD est√© disponible
      let tries=0;
      while(!window.supabase && tries<60){ await new Promise(r=>setTimeout(r,100)); tries++; }
      if(!window.supabase){ alert("No se pudo cargar supabase-js."); throw new Error("supabase no carg√≥"); }

      supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
      });
      supa.auth.onAuthStateChange(refreshSession);
      await refreshSession();
      return supa;
    }

    async function refreshSession(){
      if(!supa) return;
      const { data:{ session } } = await supa.auth.getSession();
      user = session?.user || null;
      const sEl = $("#sessionState");
      if(user){
        sEl.textContent = "Sesi√≥n: " + (user.email || user.id);
        $("#btnLogin").classList.add("hide");
        $("#btnLogout").classList.remove("hide");
        setOnline(true);
      }else{
        sEl.textContent = "Sesi√≥n: desconectado";
        $("#btnLogin").classList.remove("hide");
        $("#btnLogout").classList.add("hide");
        setOnline(false);
      }
    }

    async function doLogin(){
      try{
        await ensureSupa();
        const raw = ($("#docId").value || "").trim();
        const pwd = $("#docPwd").value || "";
        if(!raw || !pwd) return alert("Escribe ID y contrase√±a");
        const email = idToEmail(raw);
        const { error } = await supa.auth.signInWithPassword({ email, password: pwd });
        if(error) return alert("Error al iniciar sesi√≥n: " + error.message);
        $("#docPwd").value = "";
      }catch(e){ console.error("[login]", e); alert("No se pudo iniciar sesi√≥n."); }
    }
    async function doLogout(){ try{ await ensureSupa(); await supa.auth.signOut(); }catch(e){} }

    async function uploadPhoto(file){
      if(!file) return null;
      await ensureSupa();
      const ext=(file.name.split(".").pop()||"jpg").toLowerCase();
      const path=`mascotas/${uuid()}.${ext}`;
      const { error } = await supa.storage.from("fotos").upload(path, file, { upsert:false });
      if(error){ logMsg("‚ö†Ô∏è Upload: " + error.message); return null; }
      const { data } = supa.storage.from("fotos").getPublicUrl(path);
      return data.publicUrl || null;
    }

    async function saveNew(){
      if(!user) return alert("Inicia sesi√≥n para guardar.");
      await ensureSupa();
      $("#btnSave").disabled=true;

      const file=$("#f_foto")?.files?.[0];
      const foto_url = file ? await uploadPhoto(file) : null;

      const payload={
        nombre:$("#f_nombre").value.trim(),
        raza:$("#f_raza").value.trim(),
        edad:$("#f_edad").value ? Number($("#f_edad").value) : null,
        sexo:$("#f_sexo").value,
        duenio:$("#f_duenio").value.trim(),
        telefono:$("#f_tel").value.trim(),
        email:$("#f_email").value.trim(),
        historial:$("#f_hist").value.trim(),
        foto_url,
        owner_id:user.id
      };
      if(!payload.nombre){ alert("Nombre es obligatorio"); $("#btnSave").disabled=false; return; }

      const { data, error } = await supa.from("mascotas").insert(payload).select("id").single();
      if(error){ logMsg("‚úñ Insert: " + error.message); }
      else { logMsg("‚úÖ Guardado ID " + data.id); current={ id:data.id, ...payload }; $("#btnUpdate").disabled=false; $("#btnDelete").disabled=false; }
      $("#btnSave").disabled=false;
    }

    async function updateCurrent(){
      if(!user || !current) return;
      await ensureSupa();
      $("#btnUpdate").disabled=true;

      let foto_url=current.foto_url || null;
      const file=$("#f_foto")?.files?.[0];
      if(file){ const up=await uploadPhoto(file); if(up) foto_url=up; }

      const payload={
        nombre:$("#f_nombre").value.trim(),
        raza:$("#f_raza").value.trim(),
        edad:$("#f_edad").value ? Number($("#f_edad").value) : null,
        sexo:$("#f_sexo").value,
        duenio:$("#f_duenio").value.trim(),
        telefono:$("#f_tel").value.trim(),
        email:$("#f_email").value.trim(),
        historial:$("#f_hist").value.trim(),
        foto_url
      };

      const { error } = await supa.from("mascotas").update(payload).eq("id", current.id);
      if(error){ logMsg("‚úñ Update: " + error.message); }
      else { logMsg("‚úÖ Actualizado ID " + current.id); }
      $("#btnUpdate").disabled=false;
    }

    async function deleteCurrent(){
      if(!user || !current) return;
      if(!confirm(`¬øEliminar registro ID ${current.id}?`)) return;
      await ensureSupa();
      $("#btnDelete").disabled=true;
      const { error } = await supa.from("mascotas").delete().eq("id", current.id);
      if(error){ logMsg("‚úñ Delete: " + error.message); $("#btnDelete").disabled=false; return; }
      logMsg("üóëÔ∏è Eliminado ID " + current.id);
      current=null; $("#btnUpdate").disabled=true; $("#btnDelete").disabled=true; $("#results").innerHTML="";
    }

    async function search(){
      await ensureSupa();
      const q=$("#q").value.trim();
      const results=$("#results"); results.innerHTML="";
      if(!q){ results.innerHTML=`<div class="muted">Escribe un nombre o ID.</div>`; return; }

      let query = supa.from("mascotas")
        .select("id,nombre,raza,edad,sexo,duenio,telefono,email,historial,foto_url")
        .order("id",{ascending:false}).limit(20);

      const n=Number(q);
      query = (Number.isFinite(n) && String(n)===q)
        ? query.or(`id.eq.${n},nombre.ilike.%${q}%`)
        : query.ilike("nombre", `%${q}%`);

      const { data, error } = await query;
      if(error){ results.innerHTML=`<div class="muted">Error: ${error.message}</div>`; return; }
      if(!data?.length){ results.innerHTML=`<div class="muted">Sin resultados.</div>`; return; }

      data.forEach(p=>{
        const card=document.createElement("div");
        card.className="item";
        const foto=p.foto_url || "img/perrito.jpg";
        card.innerHTML=`
          <img src="${foto}" alt="${p.nombre}">
          <div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <strong>${p.nombre}</strong>
              <span class="pill">ID: ${p.id}</span>
              <span class="muted">${p.raza || ""} ${p.sexo?(" ¬∑ "+p.sexo):""}</span>
            </div>
            <div class="muted">Due√±o: ${p.duenio || "‚Äî"}</div>
          </div>`;
        card.style.cursor="pointer";
        card.onclick=()=>{ current=p; fillForm(p); $("#btnUpdate").disabled=false; $("#btnDelete").disabled=false; window.scrollTo({top:0,behavior:'smooth'}); };
        results.appendChild(card);
      });
    }

    // Listeners SIEMPRE
    function bindUIOnce(){
      if (window.__bound) return; window.__bound=true;
      $("#btnLogin").addEventListener("click", doLogin);
      $("#btnLogout").addEventListener("click", doLogout);
      $("#btnSearch").addEventListener("click", search);
      $("#q").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); search(); }});
      $("#btnSave").addEventListener("click", saveNew);
      $("#btnUpdate").addEventListener("click", updateCurrent);
      $("#btnDelete").addEventListener("click", deleteCurrent);
      $("#y").textContent=new Date().getFullYear();
    }

    // Arranque & rebind tras refresh/BFCache
    if (document.readyState!=='loading'){ bindUIOnce(); ensureSupa().catch(()=>{}); }
    else document.addEventListener('DOMContentLoaded', ()=>{ bindUIOnce(); ensureSupa().catch(()=>{}); });
    window.addEventListener('pageshow', ()=>{ bindUIOnce(); ensureSupa().catch(()=>{}); });
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ bindUIOnce(); ensureSupa().catch(()=>{}); }});
  })();
  </script>
</body>
</html>
