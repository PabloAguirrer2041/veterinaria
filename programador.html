<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel del Doctor | Veterinaria</title>
  <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--muted:#64748b;--brand:#10b981;--brand2:#059669;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--fg)}
    header{padding:16px 20px;background:#fff;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:12px}
    header h1{font-size:18px;margin:0}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    .grid{display:grid;gap:16px}
    .g2{grid-template-columns: 1fr 1fr}
    .g3{grid-template-columns: 1fr 1fr 1fr}
    @media (max-width: 900px){.g2,.g3{grid-template-columns:1fr}}
    input,select,button,textarea{padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px}
    input,select,textarea{width:100%}
    button{background:var(--brand);color:#fff;cursor:pointer}
    button:hover{background:var(--brand2)}
    .btn-danger{background:var(--danger)}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{background:#f1f5f9}
    .row-actions{display:flex;gap:8px}
    .hidden{display:none !important}
    .status{font-size:13px}
  </style>
</head>
<body>
  <header>
    <img src="./images/vet.png" alt="Vet" width="28" height="28" />
    <h1>Panel del Doctor</h1>
    <span id="status" class="muted status"></span>
  </header>

  <main class="grid g2">
    <!-- TARJETA LOGIN -->
    <section class="card" id="cardLogin">
      <h2>Iniciar sesión</h2>
      <form id="loginForm" class="grid">
        <input id="docEmail" type="email" placeholder="Correo del doctor" autocomplete="email" required />
        <input id="docPwd" name="password" type="password" placeholder="Contraseña" autocomplete="current-password" required />
        <button id="btnLogin" type="submit">Entrar</button>
      </form>
      <p class="muted" style="margin-top:8px">¿Olvidaste tu contraseña? Revisa el panel de Supabase o contacta al admin.</p>
    </section>

    <!-- TARJETA SESIÓN -->
    <section class="card" id="cardSession" class="hidden">
      <h2>Sesión</h2>
      <p id="sessionEmail" class="muted">Sin sesión</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnLogout" type="button">Cerrar sesión</button>
        <button id="btnReload" type="button" title="Forzar rehidratación">Revisar sesión</button>
      </div>
    </section>

    <!-- TARJETA BUSCADOR -->
    <section class="card hidden" id="cardSearch">
      <h2>Buscador de perros</h2>
      <div class="grid g3">
        <input id="qNombre" placeholder="Buscar por nombre (p. ej. 'firulais')" />
        <select id="qRaza">
          <option value="">Todas las razas</option>
          <option>Labrador</option>
          <option>Chihuahua</option>
          <option>Golden Retriever</option>
          <option>Pitbull</option>
          <option>Otro</option>
        </select>
        <button id="btnBuscar" type="button">Buscar</button>
      </div>
      <div style="margin-top:12px" class="muted" id="count"></div>
      <div style="overflow:auto;margin-top:10px">
        <table id="tablaPerros">
          <thead>
            <tr><th>Nombre</th><th>Raza</th><th>Edad</th><th>ID</th><th>Acciones</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- TARJETA ALTA / EDICIÓN -->
    <section class="card hidden" id="cardForm">
      <h2 id="formTitle">Agregar perro</h2>
      <form id="perroForm" class="grid g3">
        <input type="hidden" id="perroId" />
        <input id="perroNombre" placeholder="Nombre" required />
        <input id="perroRaza" placeholder="Raza" />
        <input id="perroEdad" type="number" min="0" placeholder="Edad (años)" />
        <button id="btnGuardar" type="submit">Guardar</button>
        <button id="btnCancelar" type="button">Cancelar</button>
      </form>
    </section>
  </main>

  <!-- Librería Supabase + tu singleton + lógica -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>

  <!-- main.js: ajusta URL y ANON KEY dentro -->
  <script>
  // === main.js embebido (si prefieres, colócalo en ./main.js y enlázalo con <script src="./main.js" defer>) ===
  (function(){
    // TODO: AJUSTA ESTOS DOS VALORES A TU PROYECTO
    const SUPABASE_URL = "https://TU-PROYECTO.supabase.co";
    const SUPABASE_ANON_KEY = "TU_ANON_KEY";

    let client = null;
    let creating = null;

    window.getSupa = async function(){
      if (client) return client;
      if (creating) return creating;

      creating = (async ()=>{
        let tries = 0;
        while (!window.supabase && tries < 100){ await new Promise(r=>setTimeout(r,50)); tries++; }
        if (!window.supabase) throw new Error("No se pudo cargar @supabase/supabase-js");

        client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, storageKey:"vetapp-auth-v1" }
        });

        try {
          const { data:{ session } } = await client.auth.getSession();
          if (window.onAppSession) window.onAppSession(session?.user || null);
        } catch {}

        client.auth.onAuthStateChange((_evt, sess)=>{
          if (window.onAppSession) window.onAppSession(sess?.user || null);
        });

        window.addEventListener("pageshow", async ()=>{
          try {
            const { data:{ session } } = await client.auth.getSession();
            if (window.onAppSession) window.onAppSession(session?.user || null);
          } catch {}
        });
        document.addEventListener("visibilitychange", async ()=>{
          if (!document.hidden){
            try {
              const { data:{ session } } = await client.auth.getSession();
              if (window.onAppSession) window.onAppSession(session?.user || null);
            } catch {}
          }
        });

        return client;
      })();

      return creating;
    };
  })();
  </script>

  <!-- programador.js -->
  <script src="./programador.js" defer></script>
</body>
</html>
