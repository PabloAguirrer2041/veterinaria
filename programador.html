<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doctor · Registro de mascotas</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f6f9fb; --card:#ffffff; --ink:#0f172a; --muted:#5b6b83; --brand:#0ea5a0; --line:#e6eef4;
      --shadow: 0 10px 30px rgba(16,24,40,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:980px;margin:auto;padding:20px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .link{color:var(--brand);font-weight:700;text-decoration:none}
    .muted{color:var(--muted)}
    .btn{border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn--brand{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn--danger{background:#ef4444;border-color:#ef4444;color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px}
    h1{margin:0 0 10px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    label{font-size:12px;color:#5b6b83}
    input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#93d9d7;box-shadow:0 0 0 3px rgba(14,165,160,.15)}
    textarea{min-height:110px;resize:vertical}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .results{margin-top:16px;display:grid;gap:10px}
    .item{display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .item img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef4ff;color:#305fbd;font-weight:600;font-size:12px}
    #log{margin-top:12px;white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1220;color:#e6edf3;border-radius:12px;padding:10px;max-height:220px;overflow:auto}
    footer{padding:22px 0;color:#6b7280;text-align:center}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="link" href="index.html">← Volver al menú</a>
      <div>
        <span id="sessionState" class="muted">Sesión: desconectado</span>
        <button id="btnLogin" class="btn" onclick="window.__doLogin && window.__doLogin()">Iniciar sesión</button>
        <button id="btnLogout" class="btn hide" onclick="window.__doLogout && window.__doLogout()">Cerrar sesión</button>
      </div>
    </div>

    <div class="card">
      <h1>Doctor · Registro de mascotas <span class="pill" id="state">offline</span></h1>
      <p class="muted" style="margin-top:-4px">Para guardar necesitas iniciar sesión (Supabase Auth).</p>

      <!-- BUSCAR -->
      <div class="row" style="margin:8px 0 14px">
        <input id="q" type="search" placeholder="Buscar por nombre o ID (ej. 'Luna' o '102')">
        <button id="btnSearch" class="btn btn--brand">Buscar</button>
        <button id="btnClear" class="btn">Limpiar</button>
      </div>

      <!-- FORM -->
      <div class="grid">
        <div>
          <label>Nombre</label>
          <input id="f_nombre" type="text" placeholder="Nombre de la mascota">
        </div>
        <div>
          <label>Raza</label>
          <input id="f_raza" type="text" placeholder="Beagle / Criollo…">
        </div>
        <div>
          <label>Edad</label>
          <input id="f_edad" type="number" min="0" step="1" placeholder="4">
        </div>
        <div>
          <label>Sexo</label>
          <select id="f_sexo">
            <option value="">—</option>
            <option>Hembra</option>
            <option>Macho</option>
          </select>
        </div>
        <div>
          <label>Dueño (nombre)</label>
          <input id="f_duenio" type="text" placeholder="Nombre del propietario">
        </div>
        <div>
          <label>Teléfono</label>
          <input id="f_tel" type="tel" placeholder="+52 81…">
        </div>
        <div>
          <label>Email</label>
          <input id="f_email" type="email" placeholder="propietario@correo.com">
        </div>
        <div>
          <label>Foto (opcional)</label>
          <input id="f_foto" type="file" accept="image/*">
        </div>
        <div style="grid-column:1/-1">
          <label>Historial / notas</label>
          <textarea id="f_hist" placeholder="Vacunas, alergias, observaciones…"></textarea>
        </div>
      </div>

      <div class="actions">
        <button id="btnSave" class="btn btn--brand" disabled>Guardar (nuevo)</button>
        <button id="btnUpdate" class="btn" disabled>Actualizar</button>
        <button id="btnDelete" class="btn btn--danger" disabled>Eliminar</button>
      </div>

      <div id="log" class="hide"></div>
    </div>

    <div id="results" class="results"></div>

    <footer>© <span id="y"></span> TuVet</footer>
  </div>

 <!-- SDK UMD de Supabase (debe ir antes de este script) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.6/dist/umd/supabase.min.js" crossorigin="anonymous"></script>

<script>
"use strict";

/* ====== CONFIG ====== */
const SUPABASE_URL = "https://uqtnllwlyxzfvxukvxrb.supabase.co";
const SUPABASE_ANON_KEY = "PEGA_AQUI_TU_ANON_PUBLIC_KEY"; // <- reemplaza

// Cliente con opciones para detectar el token en URL y persistir sesión
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
  },
});

const $ = (s)=>document.querySelector(s);
const stateEl = $("#state");
const sessionEl = $("#sessionState");
const btnSave = $("#btnSave"), btnUpdate = $("#btnUpdate"), btnDelete = $("#btnDelete");
let current = null;
let sessionUser = null;

function setOnline(on){
  stateEl.textContent = on ? "online" : "offline";
  stateEl.style.background = on ? "#e8fbfb" : "#ffeaea";
  stateEl.style.color = on ? "#075e59" : "#8b1a1a";
  btnSave.disabled = !on;
  btnUpdate.disabled = !on || !current;
  btnDelete.disabled = !on || !current;
}

async function refreshSession() {
  // Si el OTP nos devolvió con #access_token, getSession lo consumirá
  const { data: { session }, error } = await supa.auth.getSession();
  if (error) console.warn("getSession error:", error);
  sessionUser = session?.user || null;

  if (sessionUser) {
    sessionEl.textContent = "Sesión: " + (sessionUser.email || sessionUser.id);
    document.getElementById("btnLogin").classList.add("hide");
    document.getElementById("btnLogout").classList.remove("hide");
    setOnline(true);
  } else {
    sessionEl.textContent = "Sesión: desconectado";
    document.getElementById("btnLogin").classList.remove("hide");
    document.getElementById("btnLogout").classList.add("hide");
    setOnline(false);
  }

  // Limpia el hash de la URL (#access_token=...) para no repetir
  if (location.hash && location.hash.includes("access_token")) {
    history.replaceState({}, document.title, location.pathname);
  }
}

// ===== Login/Logout =====
window.__doLogin = async function(){
  const email = prompt("Correo del doctor (recibirás enlace de acceso):");
  if(!email) return;

  // Redirige exactamente a programador.html (agrégalo en Auth → URL Configuration)
  const redirect = new URL("programador.html", window.location.origin).href;

  const { error } = await supa.auth.signInWithOtp({
    email,
    options: {
      emailRedirectTo: redirect,
      shouldCreateUser: true,
    },
  });
  if (error) { alert("Error al iniciar sesión: " + error.message); return; }
  alert("Revisa tu correo y abre el enlace para completar el acceso.");
};

window.__doLogout = async function(){
  await supa.auth.signOut();
};

// Reacciona a cambios de sesión (por ejemplo, al volver del OTP)
supa.auth.onAuthStateChange(async (_evt, _session) => {
  await refreshSession();
});

/* ====== Storage helper: subir foto ====== */
async function uploadPhoto(file){
  if(!file) return null;
  const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
  const path = `mascotas/${crypto.randomUUID()}.${ext}`;
  const { error: upErr } = await supa.storage.from("fotos").upload(path, file, { upsert: false });
  if(upErr){ console.warn("Upload error:", upErr.message); return null; }
  const { data } = supa.storage.from("fotos").getPublicUrl(path);
  return data.publicUrl || null;
}

/* ====== CRUD ====== */
function fillForm(p){
  $("#f_nombre").value = p.nombre||"";
  $("#f_raza").value = p.raza||"";
  $("#f_edad").value = p.edad||"";
  $("#f_sexo").value = p.sexo||"";
  $("#f_duenio").value = p.duenio||"";
  $("#f_tel").value = p.telefono||"";
  $("#f_email").value = p.email||"";
  $("#f_hist").value = p.historial||"";
}

async function saveNew(){
  if(!sessionUser){ alert("Inicia sesión para guardar."); return; }
  btnSave.disabled = true;

  const fotoFile = $("#f_foto").files[0];
  const foto_url = await uploadPhoto(fotoFile);

  const payload = {
    nombre: $("#f_nombre").value.trim(),
    raza: $("#f_raza").value.trim(),
    edad: $("#f_edad").value ? Number($("#f_edad").value) : null,
    sexo: $("#f_sexo").value,
    duenio: $("#f_duenio").value.trim(),
    telefono: $("#f_tel").value.trim(),
    email: $("#f_email").value.trim(),
    historial: $("#f_hist").value.trim(),
    foto_url,
    owner_id: sessionUser.id,
  };
  if(!payload.nombre){ alert("Nombre es obligatorio"); btnSave.disabled=false; return; }

  const { data, error } = await supa.from("mascotas").insert(payload).select("id").single();
  if(error){ alert("Insert error: " + error.message); }
  else { current = { id: data.id, ...payload }; btnUpdate.disabled=false; btnDelete.disabled=false; }
  btnSave.disabled = false;
}

async function updateCurrent(){
  if(!sessionUser || !current) return;
  btnUpdate.disabled = true;

  let foto_url = current.foto_url || null;
  const fotoFile = $("#f_foto").files[0];
  if(fotoFile){
    const up = await uploadPhoto(fotoFile);
    if(up) foto_url = up;
  }

  const payload = {
    nombre: $("#f_nombre").value.trim(),
    raza: $("#f_raza").value.trim(),
    edad: $("#f_edad").value ? Number($("#f_edad").value) : null,
    sexo: $("#f_sexo").value,
    duenio: $("#f_duenio").value.trim(),
    telefono: $("#f_tel").value.trim(),
    email: $("#f_email").value.trim(),
    historial: $("#f_hist").value.trim(),
    foto_url,
  };

  const { error } = await supa.from("mascotas").update(payload).eq("id", current.id);
  if(error){ alert("Update error: " + error.message); }
  btnUpdate.disabled = false;
}

async function deleteCurrent(){
  if(!sessionUser || !current) return;
  if(!confirm("¿Eliminar registro ID " + current.id + "?")) return;
  btnDelete.disabled = true;
  const { error } = await supa.from("mascotas").delete().eq("id", current.id);
  if(error){ alert("Delete error: " + error.message); }
  else { current = null; }
  btnDelete.disabled = false;
}

async function search(){
  const q = $("#q").value.trim();
  const list = $("#results");
  list.innerHTML = "";
  if(!q){ list.innerHTML = `<div class="muted">Escribe un nombre o ID.</div>`; return; }

  const { data, error } = await supa
    .from("mascotas") // RLS decide qué ves
    .select("id,nombre,raza,edad,sexo,duenio,telefono,email,historial,foto_url")
    .or(`id.eq.${q},nombre.ilike.%${q}%`)
    .order("id", { ascending:false })
    .limit(20);

  if(error){ list.innerHTML = `<div class="muted">Error: ${error.message}</div>`; return; }
  if(!data || data.length===0){ list.innerHTML = `<div class="muted">Sin resultados.</div>`; return; }

  data.forEach(p=>{
    const card = document.createElement("div");
    card.className = "item";
    card.innerHTML = `
      <img src="${p.foto_url || 'img/perrito.jpg'}" alt="${p.nombre}">
      <div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <strong>${p.nombre}</strong>
          <span class="pill">ID: ${p.id}</span>
          <span class="muted">${p.raza || ""} ${p.sexo?(" · "+p.sexo):""}</span>
        </div>
        <div class="muted">Dueño: ${p.duenio || "—"}</div>
      </div>`;
    card.style.cursor = "pointer";
    card.onclick = ()=>{ current = p; fillForm(p); btnUpdate.disabled=false; btnDelete.disabled=false; window.scrollTo({top:0,behavior:'smooth'}); };
    list.appendChild(card);
  });
}

/* ===== Handlers y boot ===== */
document.getElementById("btnSave").onclick = saveNew;
document.getElementById("btnUpdate").onclick = updateCurrent;
document.getElementById("btnDelete").onclick = deleteCurrent;
document.getElementById("btnSearch").onclick = search;
document.getElementById("btnClear").onclick = ()=>{ 
  ["f_nombre","f_raza","f_edad","f_sexo","f_duenio","f_tel","f_email","f_hist","f_foto"].forEach(id=>{
    const el = $("#"+id); if(el && el.type==="file") el.value=""; else if(el) el.value="";
  });
  current=null; $("#results").innerHTML=""; 
};

document.getElementById("y").textContent = new Date().getFullYear();

// Al cargar la página, sincroniza estado de sesión
refreshSession();
  </script>
</body>
</html>
