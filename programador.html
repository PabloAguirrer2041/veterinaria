<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Programador NFC – Panel</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body{font-family:system-ui,Arial,sans-serif; background:#f6f9fb; color:#133; padding:24px;}
    .card{background:#fff; border-radius:16px; padding:20px; max-width:780px; margin:auto; box-shadow:0 10px 30px rgba(0,0,0,.06)}
    h1{margin:0 0 8px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    label{font-size:12px; color:#567}
    input{width:100%; padding:12px; border:1px solid #dbe1e6; border-radius:12px; outline:none}
    input:focus{border-color:#4ea3ff; box-shadow:0 0 0 3px rgba(78,163,255,.2)}
    button{padding:12px 16px; border-radius:12px; border:0; background:#1273ea; color:#fff; cursor:pointer}
    button:disabled{opacity:.5; cursor:not-allowed}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:#eef4ff; color:#305fbd; font-size:12px}
    #log{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap; background:#0b1220; color:#e6edf3; padding:14px; border-radius:12px; margin-top:16px; max-height:280px; overflow:auto}
  </style>
</head>
<body>
  <div class="card">
    <h1>Programador NFC <span id="status" class="pill">Conectando…</span></h1>
    <p>Publica un comando MQTT al ESP para grabar la etiqueta NFC.</p>

    <div class="row">
      <div>
        <label>ID mascota</label>
        <input id="id" type="number" value="1" />
      </div>
      <div>
        <label>Nombre</label>
        <input id="nombre" type="text" value="Diego" />
      </div>
    </div>
    <div style="margin-top:12px">
      <label>URL a grabar (NDEF)</label>
      <input id="url" type="url" value="https://tu-dominio/#/cliente?m=Diego&id=1" />
    </div>

    <div style="margin-top:16px; display:flex; gap:8px">
      <button id="btn">Grabar en NFC</button>
      <button id="btnPing" type="button" style="background:#546e7a">Solo probar conexión</button>
    </div>

    <div id="log"></div>
  </div>

  <script>
    // ---------- CONFIG ----------
    const CLINIC_ID = "vet123";
    const DEVICE_ID = "esp32_vet_001";

    // Broker público de pruebas (sin usuario/clave):
    // Para EMQX Serverless: 'wss://<tu-host>.emqxsl.com:8084/mqtt'
    const WS_URL   = "wss://broker.emqx.io:8084/mqtt";
    const USERNAME = "";    // si usas Serverless, completa aquí
    const PASSWORD = "";

    const topicCmd = `clinic/${CLINIC_ID}/esp/${DEVICE_ID}/cmd/write_nfc`;
    const topicAck = `clinic/${CLINIC_ID}/esp/${DEVICE_ID}/ack`;

    // ---------- UI ----------
    const $ = (s)=>document.querySelector(s);
    const log = (m)=>{ const el=$("#log"); el.textContent += m + "\n"; el.scrollTop=el.scrollHeight; };
    const setStatus = (t, ok=true)=>{ $("#status").textContent=t; $("#status").style.background = ok?"#eaf3ff":"#ffeaea"; $("#status").style.color = ok?"#214a9b":"#8b1a1a"; };

    // ---------- MQTT client (mqtt.js) ----------
    const clientId = "web_" + Math.random().toString(16).slice(2, 10);
    const options  = {
      clientId,
      clean: true,
      keepalive: 30,
      reconnectPeriod: 1500,
      connectTimeout: 10_000,
      username: USERNAME || undefined,
      password: PASSWORD || undefined,
    };
    const client = mqtt.connect(WS_URL, options);

    client.on("connect", () => {
      setStatus("Conectado", true);
      log(`[MQTT] conectado como ${clientId}`);
      client.subscribe(topicAck, { qos: 1 }, (err)=> {
        if (err) { log("[MQTT] error al suscribir ACK: " + err.message); }
        else { log("[MQTT] sub " + topicAck); }
      });
    });

    client.on("reconnect", ()=>setStatus("Reconectando…", true));
    client.on("close", ()=>setStatus("Desconectado", false));
    client.on("error", (err)=>log("[MQTT] error: " + err.message));
    client.on("message", (topic, payload) => {
      if (topic !== topicAck) return;
      let msg; try{ msg = JSON.parse(payload.toString()); }catch{ return; }
      const corr = msg.corr || "";
      if (pending.has(corr)) {
        clearTimeout(pending.get(corr).to);
        pending.get(corr).resolve(msg);
        pending.delete(corr);
      }
      log("ACK: " + JSON.stringify(msg));
    });

    // ---------- Publicar comando con corr + timeout ----------
    const pending = new Map();
    function publishWrite(id, nombre, url) {
      const corr = "c_" + Date.now().toString(36) + Math.random().toString(16).slice(2,6);
      const payload = { id:Number(id), nombre:String(nombre), url:String(url), corr };
      return new Promise((resolve, reject)=>{
        const to = setTimeout(()=>{ pending.delete(corr); reject(new Error("Timeout esperando ACK")); }, 15000);
        pending.set(corr, { resolve, reject, to });
        client.publish(topicCmd, JSON.stringify(payload), { qos:1 }, (err)=>{
          if (err){ clearTimeout(to); pending.delete(corr); reject(err); }
          else { log("→ CMD: " + JSON.stringify(payload)); }
        });
      });
    }

    // ---------- UI handlers ----------
    $("#btn").addEventListener("click", async ()=>{
      $("#btn").disabled = true;
      try{
        const id = $("#id").value;
        const nombre = $("#nombre").value.trim();
        const url = $("#url").value.trim();
        if (!id || !nombre || !url) throw new Error("Completa ID, nombre y URL");
        const ack = await publishWrite(id, nombre, url);
        setStatus(ack.ok ? "Escrito (NFC)" : "Error NFC", ack.ok);
      }catch(e){
        log("✖ " + e.message);
        setStatus("Error", false);
      }finally{
        $("#btn").disabled = false;
      }
    });

    $("#btnPing").addEventListener("click", ()=>{
      log("RSSI no disponible en navegador; prueba publicar y esperar ACK.");
    });
  </script>
</body>
</html>
