<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doctor ¬∑ Registro de mascotas</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f6f9fb; --card:#ffffff; --ink:#0f172a; --muted:#5b6b83; --brand:#0ea5a0; --line:#e6eef4;
      --shadow: 0 10px 30px rgba(16,24,40,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:980px;margin:auto;padding:20px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .link{color:var(--brand);font-weight:700;text-decoration:none}
    .muted{color:var(--muted)}
    .btn{border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn--brand{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn--danger{background:#ef4444;border-color:#ef4444;color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px}
    h1{margin:0 0 10px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    label{font-size:12px;color:#5b6b83}
    input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#93d9d7;box-shadow:0 0 0 3px rgba(14,165,160,.15)}
    textarea{min-height:110px;resize:vertical}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .results{margin-top:16px;display:grid;gap:10px}
    .item{display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .item img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef4ff;color:#305fbd;font-weight:600;font-size:12px}
    #log{margin-top:12px;white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1220;color:#e6edf3;border-radius:12px;padding:10px;max-height:220px;overflow:auto}
    footer{padding:22px 0;color:#6b7280;text-align:center}
    .hide{display:none}
    .login{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .login input{width:auto}
  </style>

  <!-- SDK UMD (defer garantiza que cargue antes del script de app) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.6/dist/umd/supabase.min.js" crossorigin="anonymous"></script>
  <script defer>
  (function(){
    'use strict';

    // ===== Config Supabase =====
    const SUPABASE_URL = "https://uqtnllwlyxzfvxukvxrb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxdG5sbHdseXh6ZnZ4dWt2eHJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTc3MjUsImV4cCI6MjA3NDQzMzcyNX0.nHfPuc-LCwGymKqhSRSIp9lmpQLKK53M6eqUP7QepUU";

    // Cliente global en window (evita re-creaci√≥n al volver del BFCache)
    if (!window.__supa) {
      if (!window.supabase) { console.error("No se carg√≥ supabase-js"); }
      window.__supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true },
      });
    }
    const supa = window.__supa;

    // ===== Helpers =====
    const $ = (s)=>document.querySelector(s);
    const idToEmail = (id)=> `${String(id||"").trim().toLowerCase()}@doctores.local`;
    let current = null;       // mascota seleccionada
    let sessionUser = null;   // usuario actual

    function setOnline(on){
      const stateEl = $("#state");
      stateEl.textContent = on ? "online" : "offline";
      stateEl.style.background = on ? "#e8fbfb" : "#ffeaea";
      stateEl.style.color = on ? "#075e59" : "#8b1a1a";

      const btnSave = $("#btnSave"), btnUpdate = $("#btnUpdate"), btnDelete = $("#btnDelete");
      if (btnSave) btnSave.disabled = !on;
      if (btnUpdate) btnUpdate.disabled = !on || !current;
      if (btnDelete) btnDelete.disabled = !on || !current;

      const idInput = $("#docId"), pwdInput = $("#docPwd");
      if (idInput) idInput.disabled = on;
      if (pwdInput) pwdInput.disabled = on;
    }

    function showLog(m){
      const logEl = $("#log");
      if (!logEl) return;
      logEl.classList.remove("hide");
      logEl.textContent += m + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    function fillForm(p){
      $("#f_nombre").value = p.nombre||"";
      $("#f_raza").value   = p.raza||"";
      $("#f_edad").value   = p.edad||"";
      $("#f_sexo").value   = p.sexo||"";
      $("#f_duenio").value = p.duenio||"";
      $("#f_tel").value    = p.telefono||"";
      $("#f_email").value  = p.email||"";
      $("#f_hist").value   = p.historial||"";
    }

    function clearForm(){
      const ids = ["f_nombre","f_raza","f_edad","f_sexo","f_duenio","f_tel","f_email","f_hist","f_foto"];
      ids.forEach(id=>{
        const el = $("#"+id);
        if (!el) return;
        if (el.type === "file") el.value = "";
        else el.value = "";
      });
      current = null;
      const btnUpdate = $("#btnUpdate"), btnDelete = $("#btnDelete");
      if (btnUpdate) btnUpdate.disabled = true;
      if (btnDelete) btnDelete.disabled = true;
    }

    async function refreshSession(){
      try{
        const { data:{ session } } = await supa.auth.getSession();
        sessionUser = session?.user || null;

        const sessionEl = $("#sessionState");
        const btnLogin  = $("#btnLogin");
        const btnLogout = $("#btnLogout");
        if (sessionUser){
          if (sessionEl) sessionEl.textContent = "Sesi√≥n: " + (sessionUser.email || sessionUser.id);
          btnLogin?.classList.add("hide");
          btnLogout?.classList.remove("hide");
          setOnline(true);
        } else {
          if (sessionEl) sessionEl.textContent = "Sesi√≥n: desconectado";
          btnLogin?.classList.remove("hide");
          btnLogout?.classList.add("hide");
          setOnline(false);
        }
      }catch(e){
        console.warn("refreshSession error:", e);
      }
    }

    async function uploadPhoto(file){
      if(!file) return null;
      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const path = `mascotas/${crypto.randomUUID()}.${ext}`;
      const { error: upErr } = await supa.storage.from("fotos").upload(path, file, { upsert: false });
      if(upErr){ showLog("‚ö†Ô∏è Upload: " + upErr.message); return null; }
      const { data } = supa.storage.from("fotos").getPublicUrl(path);
      return data.publicUrl || null;
    }

    async function saveNew(){
      if(!sessionUser) return alert("Inicia sesi√≥n para guardar.");
      const btnSave = $("#btnSave"); if (btnSave) btnSave.disabled = true;

      const fotoFile = $("#f_foto").files[0];
      const foto_url = await uploadPhoto(fotoFile);

      const payload = {
        nombre:   $("#f_nombre").value.trim(),
        raza:     $("#f_raza").value.trim(),
        edad:     $("#f_edad").value ? Number($("#f_edad").value) : null,
        sexo:     $("#f_sexo").value,
        duenio:   $("#f_duenio").value.trim(),
        telefono: $("#f_tel").value.trim(),
        email:    $("#f_email").value.trim(),
        historial:$("#f_hist").value.trim(),
        foto_url,
        owner_id: sessionUser.id
      };
      if(!payload.nombre){ alert("Nombre es obligatorio"); if(btnSave) btnSave.disabled=false; return; }

      const { data, error } = await supa.from("mascotas").insert(payload).select("id").single();
      if(error){ showLog("‚úñ Insert: " + error.message); }
      else { showLog("‚úÖ Guardado ID " + data.id); current = { id: data.id, ...payload }; $("#btnUpdate").disabled=false; $("#btnDelete").disabled=false; }
      if(btnSave) btnSave.disabled = false;
    }

    async function updateCurrent(){
      if(!sessionUser || !current) return;
      const btnUpdate = $("#btnUpdate"); if (btnUpdate) btnUpdate.disabled = true;

      let foto_url = current.foto_url || null;
      const fotoFile = $("#f_foto").files[0];
      if(fotoFile){ const up = await uploadPhoto(fotoFile); if(up) foto_url = up; }

      const payload = {
        nombre:   $("#f_nombre").value.trim(),
        raza:     $("#f_raza").value.trim(),
        edad:     $("#f_edad").value ? Number($("#f_edad").value) : null,
        sexo:     $("#f_sexo").value,
        duenio:   $("#f_duenio").value.trim(),
        telefono: $("#f_tel").value.trim(),
        email:    $("#f_email").value.trim(),
        historial:$("#f_hist").value.trim(),
        foto_url
      };

      const { error } = await supa.from("mascotas").update(payload).eq("id", current.id);
      if(error){ showLog("‚úñ Update: " + error.message); }
      else { showLog("‚úÖ Actualizado ID " + current.id); }
      if(btnUpdate) btnUpdate.disabled = false;
    }

    async function deleteCurrent(){
      if(!sessionUser || !current) return;
      if(!confirm("¬øEliminar registro ID " + current.id + "?")) return;
      const btnDelete = $("#btnDelete"); if (btnDelete) btnDelete.disabled = true;

      const { error } = await supa.from("mascotas").delete().eq("id", current.id);
      if(error){ showLog("‚úñ Delete: " + error.message); if(btnDelete) btnDelete.disabled=false; return; }
      showLog("üóëÔ∏è Eliminado ID " + current.id);
      clearForm(); $("#results").innerHTML=""; if(btnDelete) btnDelete.disabled=false;
    }

    async function search(){
      const q = $("#q").value.trim();
      const results = $("#results");
      results.innerHTML = "";
      if(!q){ results.innerHTML = `<div class="muted">Escribe un nombre o ID.</div>`; return; }

      let query = supa
        .from("mascotas")
        .select("id,nombre,raza,edad,sexo,duenio,telefono,email,historial,foto_url")
        .order("id",{ascending:false})
        .limit(20);

      const asNumber = Number(q);
      if (Number.isFinite(asNumber) && String(asNumber) === q){
        query = query.or(`id.eq.${asNumber},nombre.ilike.%${q}%`);
      } else {
        query = query.ilike("nombre", `%${q}%`);
      }

      const { data, error } = await query;
      if(error){ results.innerHTML = `<div class="muted">Error: ${error.message}</div>`; return; }
      if(!data || data.length===0){ results.innerHTML = `<div class="muted">Sin resultados.</div>`; return; }

      data.forEach(p=>{
        const card = document.createElement("div");
        card.className = "item";
        const foto = p.foto_url || "img/perrito.jpg";
        card.innerHTML = `
          <img src="${foto}" alt="${p.nombre}">
          <div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <strong>${p.nombre}</strong>
              <span class="pill">ID: ${p.id}</span>
              <span class="muted">${p.raza || ""} ${p.sexo?(" ¬∑ "+p.sexo):""}</span>
            </div>
            <div class="muted">Due√±o: ${p.duenio || "‚Äî"}</div>
          </div>
        `;
        card.style.cursor = "pointer";
        card.onclick = ()=>{ current = p; fillForm(p); $("#btnUpdate").disabled=false; $("#btnDelete").disabled=false; window.scrollTo({top:0,behavior:'smooth'}); };
        results.appendChild(card);
      });
    }

    // ===== Delegaci√≥n de eventos (nunca se rompen los handlers) =====
    document.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("button");
      if (!btn) return;
      switch (btn.id) {
        case "btnLogin": {
          const id  = $("#docId").value.trim();
          const pwd = $("#docPwd").value;
          if(!id || !pwd){ alert("Escribe ID y contrase√±a"); return; }
          const email = idToEmail(id);
          supa.auth.signInWithPassword({ email, password: pwd })
            .then(({error})=>{
              if(error) alert("Error al iniciar sesi√≥n: " + error.message);
              else $("#docPwd").value = "";
            });
          break;
        }
        case "btnLogout":
          supa.auth.signOut();
          break;
        case "btnSave":
          saveNew();
          break;
        case "btnUpdate":
          updateCurrent();
          break;
        case "btnDelete":
          deleteCurrent();
          break;
        case "btnSearch":
          search();
          break;
        case "btnClear": {
          clearForm();
          const results = $("#results"); if (results) results.innerHTML = "";
          const logEl = $("#log"); if (logEl){ logEl.textContent = ""; logEl.classList.add("hide"); }
          break;
        }
      }
    });

    // Enter en el buscador (delegado)
    document.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" && e.target && e.target.id === "q"){
        e.preventDefault();
        search();
      }
    });

    // Rehidrataci√≥n: al volver del men√∫ (BFCache) y al reenfocar
    window.addEventListener("pageshow", refreshSession);
    document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) refreshSession(); });

    // Boot
    document.addEventListener("DOMContentLoaded", ()=>{
      document.getElementById("y").textContent = new Date().getFullYear();
      refreshSession();
    });
  })();
  </script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="link" href="index.html">‚Üê Volver al men√∫</a>
      <div class="login">
        <span id="sessionState" class="muted">Sesi√≥n: desconectado</span>
        <input id="docId"  type="text" placeholder="ID (p.ej. DRPERRON1)" autocomplete="username">
        <input id="docPwd" type="password" placeholder="Contrase√±a" autocomplete="current-password">
        <button id="btnLogin"  class="btn">Iniciar sesi√≥n</button>
        <button id="btnLogout" class="btn hide">Cerrar sesi√≥n</button>
      </div>
    </div>

    <div class="card">
      <h1>Doctor ¬∑ Registro de mascotas <span class="pill" id="state">offline</span></h1>
      <p class="muted" style="margin-top:-4px">Solo doctores autorizados pueden crear o editar registros.</p>

      <div class="row" style="margin:8px 0 14px">
        <input id="q" type="search" placeholder="Buscar por nombre o ID (ej. 'Luna' o '102')">
        <button id="btnSearch" class="btn btn--brand">Buscar</button>
        <button id="btnClear" class="btn">Limpiar</button>
      </div>

      <div class="grid">
        <div><label>Nombre</label><input id="f_nombre" type="text" placeholder="Nombre de la mascota"></div>
        <div><label>Raza</label><input id="f_raza" type="text" placeholder="Beagle / Criollo‚Ä¶"></div>
        <div><label>Edad</label><input id="f_edad" type="number" min="0" step="1" placeholder="4"></div>
        <div><label>Sexo</label><select id="f_sexo"><option value="">‚Äî</option><option>Hembra</option><option>Macho</option></select></div>
        <div><label>Due√±o (nombre)</label><input id="f_duenio" type="text" placeholder="Nombre del propietario"></div>
        <div><label>Tel√©fono</label><input id="f_tel" type="tel" placeholder="+52 81‚Ä¶"></div>
        <div><label>Email</label><input id="f_email" type="email" placeholder="propietario@correo.com"></div>
        <div><label>Foto (opcional)</label><input id="f_foto" type="file" accept="image/*"></div>
        <div style="grid-column:1/-1"><label>Historial / notas</label><textarea id="f_hist" placeholder="Vacunas, alergias, observaciones‚Ä¶"></textarea></div>
      </div>

      <div class="actions">
        <button id="btnSave" class="btn btn--brand" disabled>Guardar (nuevo)</button>
        <button id="btnUpdate" class="btn" disabled>Actualizar</button>
        <button id="btnDelete" class="btn btn--danger" disabled>Eliminar</button>
      </div>

      <div id="log" class="hide"></div>
    </div>

    <div id="results" class="results"></div>

    <footer>¬© <span id="y"></span> TuVet</footer>
  </div>
</body>
</html>
